USE [AlarmsServer]
GO
/****** Object:  Trigger [dbo].[UpdateAlarmeTRAfterInsert1]    Script Date: 11/09/2023 10:23:43 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER TRIGGER [dbo].[UpdateAlarmeTRAfterInsert1]
ON [dbo].[Journal]
AFTER insert
AS
BEGIN

   /*  a.NombreNonLu = CASE WHEN (SELECT COUNT(*) FROM Journal j WHERE j.IdAlarme = i.IdAlarme AND j.LU = 1)
                     = (SELECT COUNT(*) FROM Journal j WHERE j.IdAlarme = i.IdAlarme) THEN 1 ELSE 0 END,  */


    DECLARE @NombreNonLu INT;




	SELECT @NombreNonLu = COUNT(*) FROM Journal j  INNER JOIN INSERTED i ON j.IdAlarme = i.IdAlarme WHERE j.IdAlarme = i.IdAlarme AND j.LU = 0 

	if(@NombreNonLu > 1)
		begin
		UPDATE a
		SET  a.NombreNonLu = @NombreNonLu ,        
			a.status = CASE WHEN i.Status0 IS NULL THEN i.Status1 ELSE i.Status0 END,
			a.ts = GETDATE(),
			a.Station = i.Station
		FROM AlarmeTR a
		INNER JOIN INSERTED i ON a.IdAlarme = i.IdAlarme;
		end;
	else 
		begin

		INSERT INTO AlarmeTR (IdAlarme,Status, TS, Station, NombreNonLu)
			SELECT i.IdAlarme, CASE WHEN i.Status0 IS NULL THEN i.Status1 ELSE i.Status0 END, GETDATE(), i.Station, 1
			FROM INSERTED i
	End;



END;